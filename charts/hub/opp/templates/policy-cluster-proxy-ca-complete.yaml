apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  annotations:
    policy.open-cluster-management.io/categories: CA Assessment Authorization and
      Monitoring
    policy.open-cluster-management.io/controls: CA-7 Continuous Monitoring
    policy.open-cluster-management.io/standards: NIST SP 800-53
    argocd.argoproj.io/compare-options: IgnoreExtraneous
    argocd.argoproj.io/sync-options: Prune=false
    argocd.argoproj.io/health-check-ignore: "true"
    argocd.argoproj.io/hook: "PostSync"
    argocd.argoproj.io/sync-wave: "2"
  labels:
    app.kubernetes.io/name: cluster-proxy-ca
    app.kubernetes.io/component: policy
  name: policy-cluster-proxy-ca-complete
  namespace: open-cluster-management
spec:
  disabled: false
  policy-templates:
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: policy-cluster-proxy-ca-complete
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        object-templates:
        - complianceType: musthave
          recreateOption: recreate
          objectDefinition:
            apiVersion: batch/v1
            kind: Job
            metadata:
              name: extract-and-distribute-cas
              namespace: openshift-config
              labels:
                app.kubernetes.io/name: cluster-proxy-ca
                app.kubernetes.io/component: ca-extraction
              annotations:
                argocd.argoproj.io/hook: "PostSync"
                argocd.argoproj.io/hook-delete-policy: "HookSucceeded"
                argocd.argoproj.io/sync-wave: "2"
            spec:
              template:
                spec:
                  containers:
                  - name: ca-extractor
                    image: registry.redhat.io/openshift4/ose-cli:latest
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "100m"
                      limits:
                        memory: "512Mi"
                        cpu: "200m"
                    command:
                    - /bin/bash
                    - -c
                    - |
                      set -euo pipefail
                      
                      echo "Starting complete CA extraction and distribution..."
                      
                      # Create combined CA bundle
                      CA_BUNDLE_FILE="/tmp/combined-ca-bundle.crt"
                      touch "$CA_BUNDLE_FILE"
                      
                      # Extract hub cluster CA from multiple sources
                      echo "Extracting hub cluster CA..."
                      
                      # Try openshift-config-managed first
                      if oc get configmap -n openshift-config-managed trusted-ca-bundle -o jsonpath="{.data['ca-bundle\.crt']}" >> "$CA_BUNDLE_FILE" 2>/dev/null; then
                        echo "  CA extracted from openshift-config-managed"
                      fi
                      
                      # Try openshift-config as backup
                      if oc get configmap -n openshift-config trusted-ca-bundle -o jsonpath="{.data['ca-bundle\.crt']}" >> "$CA_BUNDLE_FILE" 2>/dev/null; then
                        echo "  CA extracted from openshift-config"
                      fi
                      
                      # Try cluster proxy CA
                      if oc get proxy cluster -o jsonpath='{.spec.trustedCA.name}' 2>/dev/null | xargs -I {} oc get configmap {} -n openshift-config -o jsonpath='{.data.ca-bundle\.crt}' >> "$CA_BUNDLE_FILE" 2>/dev/null; then
                        echo "  CA extracted from cluster proxy"
                      fi
                      
                      # Get managed clusters and extract their CAs
                      echo "Extracting managed cluster CAs..."
                      MANAGED_CLUSTERS=$(oc get managedclusters -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
                      
                      for cluster in $MANAGED_CLUSTERS; do
                        if [[ "$cluster" == "local-cluster" ]]; then
                          continue
                        fi
                        echo "Processing cluster: $cluster"
                        
                        # Try ManagedClusterInfo first
                        CA_DATA=$(oc get managedclusterinfo -n "$cluster" -o jsonpath='{.items[0].status.distributionInfo.ocp.managedClusterClientConfig.caBundle}' 2>/dev/null)
                        if [[ -n "$CA_DATA" ]] && echo "$CA_DATA" | base64 -d 2>/dev/null | grep -q "BEGIN CERTIFICATE"; then
                          echo "$CA_DATA" | base64 -d >> "$CA_BUNDLE_FILE" 2>/dev/null
                          echo "  CA extracted from ManagedClusterInfo"
                        else
                          echo "  No CA found in ManagedClusterInfo for $cluster"
                        fi
                      done
                      
                      # Clean up duplicates and validate content
                      sort "$CA_BUNDLE_FILE" | uniq > "${CA_BUNDLE_FILE}.tmp" && mv "${CA_BUNDLE_FILE}.tmp" "$CA_BUNDLE_FILE"
                      
                      # Validate CA bundle has content
                      if [[ ! -s "$CA_BUNDLE_FILE" ]] || [[ ! $(grep -c "BEGIN CERTIFICATE" "$CA_BUNDLE_FILE") -gt 0 ]]; then
                        echo "ERROR: No valid CA certificates found in bundle"
                        echo "CA bundle content:"
                        cat "$CA_BUNDLE_FILE"
                        exit 1
                      fi
                      
                      echo "CA bundle validation successful. Found $(grep -c "BEGIN CERTIFICATE" "$CA_BUNDLE_FILE") certificates."
                      
                      # Create ConfigMap on hub cluster
                      echo "Creating cluster-proxy-ca-bundle ConfigMap on hub..."
                      oc create configmap cluster-proxy-ca-bundle \
                        --from-file=ca-bundle.crt="$CA_BUNDLE_FILE" \
                        -n openshift-config \
                        --dry-run=client -o yaml | oc apply -f -
                      
                      # Update hub cluster proxy
                      echo "Updating hub cluster proxy..."
                      oc patch proxy/cluster --type=merge --patch='{"spec":{"trustedCA":{"name":"cluster-proxy-ca-bundle"}}}' || true
                      
                      echo "CA bundle extraction and hub proxy update completed successfully."
                      
                      # Create placement rule for managed clusters
                      echo "Creating placement rule for managed clusters..."
                      cat <<EOF | oc apply -f -
                      apiVersion: apps.open-cluster-management.io/v1
                      kind: PlacementRule
                      metadata:
                        name: placement-cluster-proxy-ca-bundle
                        namespace: open-cluster-management
                      spec:
                        clusterConditions:
                        - type: ManagedClusterConditionAvailable
                          status: "True"
                        clusterSelector:
                          matchExpressions:
                          - key: cluster.open-cluster-management.io/clusterset
                            operator: Exists
                      EOF
                      
                      # Create placement binding
                      echo "Creating placement binding..."
                      cat <<EOF | oc apply -f -
                      apiVersion: policy.open-cluster-management.io/v1
                      kind: PlacementBinding
                      metadata:
                        name: binding-cluster-proxy-ca-bundle
                        namespace: open-cluster-management
                      placementRef:
                        name: placement-cluster-proxy-ca-bundle
                        kind: PlacementRule
                        apiGroup: apps.open-cluster-management.io
                      subjects:
                      - name: policy-cluster-proxy-ca-bundle-distribution
                        kind: Policy
                        apiGroup: policy.open-cluster-management.io
                      EOF
                      
                      echo "CA extraction and distribution setup completed"
                    env:
                    - name: KUBECONFIG
                      value: ""
                  restartPolicy: Never
                  serviceAccountName: ca-extractor-sa
              backoffLimit: 1
              activeDeadlineSeconds: 600
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              name: ca-extractor-sa
              namespace: openshift-config
              labels:
                app.kubernetes.io/name: cluster-proxy-ca
                app.kubernetes.io/component: ca-extraction
        - complianceType: musthave
          objectDefinition:
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRole
            metadata:
              name: ca-extractor-role
              labels:
                app.kubernetes.io/name: cluster-proxy-ca
                app.kubernetes.io/component: ca-extraction
            rules:
            - apiGroups: [""]
              resources: ["configmaps"]
              verbs: ["get", "list", "create", "update", "patch"]
            - apiGroups: ["config.openshift.io"]
              resources: ["proxies"]
              verbs: ["get", "patch"]
            - apiGroups: ["cluster.open-cluster-management.io"]
              resources: ["managedclusters"]
              verbs: ["get", "list"]
            - apiGroups: ["internal.open-cluster-management.io"]
              resources: ["managedclusterinfos"]
              verbs: ["get", "list"]
            - apiGroups: ["policy.open-cluster-management.io"]
              resources: ["policies", "placementrules", "placementbindings"]
              verbs: ["get", "list", "create", "update", "patch"]
            - apiGroups: ["apps.open-cluster-management.io"]
              resources: ["placementrules"]
              verbs: ["get", "list", "create", "update", "patch"]
        - complianceType: musthave
          objectDefinition:
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRoleBinding
            metadata:
              name: ca-extractor-rolebinding
              labels:
                app.kubernetes.io/name: cluster-proxy-ca
                app.kubernetes.io/component: ca-extraction
            subjects:
            - kind: ServiceAccount
              name: ca-extractor-sa
              namespace: openshift-config
            roleRef:
              kind: ClusterRole
              name: ca-extractor-role
              apiGroup: rbac.authorization.k8s.io
        remediationAction: enforce
        severity: high
